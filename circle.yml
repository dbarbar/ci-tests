machine:
  hosts:
    local.dev: 127.0.0.1
  php:
    version: 5.4.21
dependencies:
  cache_directories:
    - "~/.drush/cache"
  pre:
    - sudo composer self-update
  post:
    - ./vendor/bin/drush make springboard-mtsb.make docroot
    - "chmod -R 777 docroot/sites/default"
    - cp vhost.conf /etc/apache2/sites-available/local.dev
    - a2ensite local.dev
    - sudo service apache2 restart
test:
  pre:
    - "cd docroot && ../vendor/bin/drush si sbsetup install_configure_form.update_status_module='array(FALSE,FALSE)' --account-name=admin --account-pass=admin --account-mail=david.barbarisi@jacksonriver.com --clean-url=1 --site-mail=david.barbarisi@jacksonriver.com --site-name=4x --db-url=mysql://ubuntu:@127.0.0.1:3306/circle_test --yes"
    - "cd docroot && ../vendor/bin/drush cc all && ../vendor/bin/drush sql-dump --result-file=$CIRCLE_ARTIFACTS/dump.sql"
    - "cd docroot && ../vendor/bin/drush status"
    - 'curl --max-time 20 http://local.dev:8080 | grep "DONATE"'
  override:
    - "cd docroot && ../vendor/bin/drush -l http://local.dev:8080 en springboard_tests -y"
    - "cd docroot && ../vendor/bin/drush -l http://local.dev:8080 sb-test-run springboard --xml=$CIRCLE_TEST_REPORTS"
  post:
    - "cp *.make $CIRCLE_ARTIFACTS"
    - tar zcvf $CIRCLE_ARTIFACTS/package.tar.gz docroot -c docroot
